services:
  - type: web
    name: worktime-app
    env: node
    buildCommand: |
      echo "🚀 開始建置流程..."
      echo "📁 當前目錄: $(pwd)"
      
      # 安裝依賴
      echo "📦 安裝根目錄依賴..."
      npm install
      
      echo "📦 安裝前端依賴..."
      cd client && npm install && cd ..
      
      echo "📦 安裝後端依賴..."
      cd server && npm install && cd ..
      
      # 建置前端
      echo "🔨 建置前端應用程式..."
      cd client
      npm run build
      cd ..
      
      # 檢查建置結果
      echo "🔍 檢查建置結果..."
      if [ ! -d "client/build" ]; then
        echo "❌ 前端建置失敗：client/build 目錄不存在"
        exit 1
      fi
      
      if [ ! -f "client/build/index.html" ]; then
        echo "❌ 前端建置失敗：index.html 檔案不存在"
        exit 1
      fi
      
      echo "✅ 前端建置成功"
      echo "📋 建置檔案內容:"
      ls -la client/build/
      
      # 複製到伺服器目錄
      echo "📋 複製建置檔案到伺服器目錄..."
      rm -rf server/build
      cp -r client/build server/
      
      # 驗證複製結果
      echo "🔍 驗證複製結果..."
      if [ ! -f "server/build/index.html" ]; then
        echo "❌ 複製失敗：server/build/index.html 不存在"
        exit 1
      fi
      
      echo "✅ 建置檔案複製成功"
      echo "📋 伺服器建置目錄內容:"
      ls -la server/build/
      
      echo "🎉 建置流程完成！"
    startCommand: NODE_ENV=production node server/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
    healthCheckPath: /health
    autoDeploy: true 